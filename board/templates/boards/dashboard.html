{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

    {# ================================================= #}
    {# 1. สรุปงานของฉัน (Task Summary) + ตัวกรอง        #}
    {#    (ย้ายขึ้นมาเป็นส่วนแรก)                         #}
    {# ================================================= #}
    <div x-data="{ filter: 'all' }">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                 งานของฉัน (My Tasks)
            </h2>
            
            {# ปุ่มตัวกรอง (Filter Tabs) #}
            <div class="bg-gray-100 p-1 rounded-lg inline-flex self-start sm:self-auto">
                <button 
                    @click="filter = 'all'" 
                    :class="filter === 'all' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2"
                >
                    ทั้งหมด <span class="bg-gray-200 text-gray-600 px-1.5 rounded-full text-[10px]">{{ counts.all }}</span>
                </button>

                <button 
                    @click="filter = 'week'" 
                    :class="filter === 'week' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2"
                >
                    Week นี้ <span class="bg-orange-100 text-orange-600 px-1.5 rounded-full text-[10px]">{{ counts.week }}</span>
                </button>

                <button 
                    @click="filter = 'overdue'" 
                    :class="filter === 'overdue' ? 'bg-white text-red-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2"
                >
                    เลยกำหนด <span class="bg-red-100 text-red-600 px-1.5 rounded-full text-[10px]">{{ counts.overdue }}</span>
                </button>
            </div>
        </div>

        {# ตารางงาน #}
        <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ชื่องาน</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">โปรเจกต์</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานะ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">กำหนดส่ง</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in task_list_data %}
                        {# ใช้ x-show กรองแถวตามสถานะ #}
                        <tr 
                            x-show="(filter === 'all') || (filter === 'overdue' && {{ item.is_overdue|yesno:'true,false' }}) || (filter === 'week' && {{ item.is_week|yesno:'true,false' }})"
                            class="hover:bg-gray-50 transition-colors cursor-pointer" 
                            onclick="window.location.href='{% url 'board_detail' item.obj.list.board.id %}'"
                        >
                            <td class="px-6 py-4">
                                <div class="text-sm font-bold text-gray-800">{{ item.obj.title }}</div>
                                {% if item.obj.priority == 'high' %}
                                    <span class="text-[10px] text-red-600 font-bold bg-red-50 px-1 rounded">High Priority</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-xs text-gray-500">
                                     {{ item.obj.list.board.name }}
                                    <span class="mx-1">/</span>
                                    {{ item.obj.list.title }}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-0.5 inline-flex text-xs font-semibold rounded-full 
                                    {% if item.obj.status == 'todo' %}bg-gray-100 text-gray-600
                                    {% elif item.obj.status == 'in_progress' %}bg-blue-100 text-blue-600
                                    {% endif %}">
                                    {{ item.obj.get_status_display }}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                {% if item.obj.due_date %}
                                    <div class="flex items-center gap-2 text-sm">
                                        {# แสดงวันที่ + สีตามสถานะ #}
                                        {% if item.is_overdue %}
                                            <span class="text-red-600 font-bold flex items-center gap-1">
                                                 {{ item.obj.due_date|date:"d M" }}
                                            </span>
                                        {% elif item.is_week %}
                                            <span class="text-orange-500 font-medium flex items-center gap-1">
                                                 {{ item.obj.due_date|date:"d M" }}
                                            </span>
                                        {% else %}
                                            <span class="text-gray-500">
                                                {{ item.obj.due_date|date:"d M" }}
                                            </span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-gray-400">
                                ไม่มีงานค้างในขณะนี้ 
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                {# ข้อความเมื่อกด Filter แล้วไม่เจอข้อมูล (Optional) #}
                <div x-show="filter === 'overdue' && {{ counts.overdue }} === 0" class="p-8 text-center text-gray-400 bg-white hidden" :class="{'block': true, 'hidden': false}">
                     ไม่มีงานที่เลยกำหนด
                </div>
                 <div x-show="filter === 'week' && {{ counts.week }} === 0" class="p-8 text-center text-gray-400 bg-white hidden" :class="{'block': true, 'hidden': false}">
                     ไม่มีงานที่ต้องส่งในสัปดาห์นี้
                </div>
            </div>
        </div>
    </div>

    {# ================================================= #}
    {# 2. กล่องจดหมาย / คำเชิญ (Invitations Box)         #}
    {#    (ย้ายลงมาอยู่ใต้ Task Summary)                  #}
    {# ================================================= #}
    {% if received_invites %}
    <div class="bg-white rounded-xl shadow-md border-l-4 border-indigo-500 overflow-hidden">
        <div class="p-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
            <h3 class="text-indigo-900 font-bold flex items-center gap-2">
                 คำเชิญเข้าร่วมโปรเจกต์ใหม่ ({{ received_invites.count }})
            </h3>
        </div>
        <div class="divide-y divide-gray-100">
            {% for invite in received_invites %}
            <div class="p-4 flex flex-col sm:flex-row justify-between items-center gap-4 hover:bg-gray-50 transition-colors">
                <div class="flex items-center gap-3">
                    {# Avatar คนเชิญ #}
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">
                        {{ invite.sender.username.0|upper }}
                    </div>
                    <div>
                        <p class="text-gray-800 text-sm">
                            <span class="font-bold">{{ invite.sender.username }}</span> เชิญคุณเข้าร่วม
                        </p>
                        <p class="text-indigo-600 font-bold text-lg leading-tight">
                            "{{ invite.board.name }}"
                        </p>
                    </div>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <a href="{% url 'respond_invitation' invite.id 'accept' %}" class="flex-1 sm:flex-none text-center bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 shadow-sm transition-all">
                        ตอบรับ
                    </a>
                    <a href="{% url 'respond_invitation' invite.id 'decline' %}" class="flex-1 sm:flex-none text-center bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 hover:text-red-600 transition-all">
                        ปฏิเสธ
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# ส่วนแสดงโปรเจกต์ทั้งหมด ถูกลบออกไปแล้ว #}

</div>
{% endblock %}