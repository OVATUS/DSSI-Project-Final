{# board/templates/boards/calendar_main.html #}
{% extends "base.html" %}

{% block content %}
<div class="h-screen flex flex-col bg-gray-50 overflow-hidden relative">

    {# --- 1. HEADER & FILTER BAR --- #}
    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm shrink-0 z-20 relative">
        
        {# Title (Left) #}
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 leading-tight">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°</h1>
                <p class="text-xs text-gray-500">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>
        </div>

        {# Controls (Right): Google Sync Button + Filter Dropdown #}
        <div class="flex items-center gap-4">
            
            {# Google Calendar Sync Button #}
            <div>
                {% if request.session.google_credentials %}
                    <span class="inline-flex items-center px-3 py-1.5 bg-green-50 text-green-700 text-xs font-semibold rounded-full border border-green-100 shadow-sm cursor-default" title="‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß">
                        <svg class="w-3.5 h-3.5 mr-1.5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                        Google Calendar Connected
                    </span>
                {% else %}
                    <a href="{% url 'google_calendar_init' %}" 
                       class="inline-flex items-center px-3 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg text-xs font-bold hover:bg-gray-50 hover:text-indigo-600 hover:border-indigo-300 transition-all shadow-sm group">
                       <svg class="w-4 h-4 mr-2 text-gray-400 group-hover:text-indigo-500 transition-colors" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                       Sync Google Calendar
                    </a>
                {% endif %}
            </div>

            <div class="h-6 w-px bg-gray-200"></div> {# Divider #}

            {# Filter Dropdown #}
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                </div>
                <select id="boardFilter" class="pl-9 pr-8 py-2 text-sm bg-gray-50 border border-gray-200 text-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:bg-white transition-colors cursor-pointer shadow-sm min-w-[180px]">
                    <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</option>
                    {% for board in boards %}
                    <option value="{{ board.id }}">{{ board.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </header>

    {# --- 2. CALENDAR AREA --- #}
    <div class="flex-1 p-4 sm:p-6 overflow-hidden">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 h-full p-2 sm:p-4 overflow-hidden flex flex-col">
            {# Calendar Container #}
            <div id="calendar" class="flex-1"></div>
        </div>
    </div>

</div>

{# --- FullCalendar & Scripts --- #}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var boardFilter = document.getElementById('boardFilter');
        
        // 1. Init Calendar
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            buttonText: {
                today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
                month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
                list: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£'
            },
            locale: 'th',
            navLinks: true,
            dayMaxEvents: true,
            height: '100%',
            
            // --- Feature 1: Drag & Drop Configuration ---
            editable: true, // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ

            // ‡∏Å‡∏è‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å: ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Task ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (‡∏ó‡∏µ‡πà‡∏°‡∏µ URL /board/...) ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏≤‡∏Å Google Event ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            eventAllow: function(dropInfo, draggedEvent) {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å extendedProps ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Backend
                if (draggedEvent.extendedProps.is_google || draggedEvent.extendedProps.type === 'schedule') {
                    return false;
                }
                return true;
            },

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á (Drop) ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?
            eventDrop: function(info) {
                // ‡∏î‡∏∂‡∏á Task ID ‡∏à‡∏≤‡∏Å URL (‡πÄ‡∏ä‡πà‡∏ô ...?task_id=55)
                let taskId = null;
                if (info.event.url && info.event.url.includes('task_id=')) {
                    const urlParams = new URLSearchParams(info.event.url.split('?')[1]);
                    taskId = urlParams.get('task_id');
                }

                if (taskId) {
                    // ‡∏¢‡∏¥‡∏á AJAX ‡πÑ‡∏õ‡∏ö‡∏≠‡∏Å Backend
                    fetch('{% url "api_update_task_date" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            new_date: info.event.startStr.split('T')[0] // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏Ñ‡πà YYYY-MM-DD
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.error || 'Cannot update date'));
                            info.revert(); // ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Network error');
                        info.revert();
                    });
                } else {
                    info.revert();
                }
            },

            // --- Navigation ---
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Link ‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ï‡∏≤‡∏° Link
            eventClick: function(info) {
                info.jsEvent.preventDefault(); // ‡∏´‡∏¢‡∏∏‡∏î Default ‡∏Ç‡∏≠‡∏á Browser ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                if (info.event.url) {
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Google / Meet, ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Task
                    if (info.event.extendedProps.is_google) {
                        window.open(info.event.url, '_blank');
                    } else {
                        window.location.href = info.event.url;
                    }
                }
            },

            // ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Event
            events: '{% url "api_calendar_events" %}?board_id=all',

            // --- Feature 2 & 3: Custom UI (Meet Icon) ---
            eventContent: function(arg) {
                let isMeet = arg.event.extendedProps.has_meet;
                let isGoogle = arg.event.extendedProps.is_google;
                let titleText = arg.event.title;
                
                let iconHtml = '';
                if (isMeet) {
                    iconHtml = '<span class="mr-1 text-[10px] shrink-0">üìπ</span>'; // ‡πÄ‡∏û‡∏¥‡πà‡∏° shrink-0 ‡∏Å‡∏±‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ö‡∏µ‡πâ
                } else if (!isGoogle) {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Task ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏™‡πà‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
                    iconHtml = '<span class="w-1.5 h-1.5 rounded-full bg-white shrink-0 opacity-70 mr-1"></span>';
                }

                let italicEl = document.createElement('div');
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö: ‡πÄ‡∏û‡∏¥‡πà‡∏° w-full ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà ‡πÅ‡∏•‡∏∞ flex-1 min-w-0 ‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ
                italicEl.className = 'w-full overflow-hidden'; // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÉ‡∏´‡πâ wrapper ‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≠‡∏Å‡∏™‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢
                italicEl.innerHTML = `
                    <div class="flex items-center px-1 py-0.5 w-full">
                        ${iconHtml}
                        <div class="text-xs font-medium truncate flex-1 min-w-0 ${isMeet ? 'font-bold text-white' : ''}">
                            ${titleText}
                        </div>
                    </div>
                `;
                return { domNodes: [italicEl] }
            }
        });
        
        calendar.render();

        // Filter Logic
        boardFilter.addEventListener('change', function() {
            var selectedBoardId = this.value;
            var oldSource = calendar.getEventSources()[0];
            if (oldSource) { oldSource.remove(); }
            calendar.addEventSource(`{% url "api_calendar_events" %}?board_id=${selectedBoardId}`);
        });
    });
</script>

{# --- Custom CSS --- #}
<style>
    .fc { font-family: 'Inter', sans-serif; }
    .fc-toolbar-title { font-size: 1.25rem !important; font-weight: 800; color: #1f2937; }
    
    .fc-button-primary { 
        background-color: white !important; 
        border-color: #e5e7eb !important; 
        color: #4b5563 !important; 
        font-weight: 600 !important;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 0.5rem 1rem !important;
        transition: all 0.2s;
    }
    .fc-button-primary:hover { 
        background-color: #f9fafb !important; 
        color: #111827 !important;
        border-color: #d1d5db !important;
    }
    .fc-button-active { 
        background-color: #eef2ff !important; 
        color: #4f46e5 !important;
        border-color: #c7d2fe !important;
    }

    .fc-theme-standard td, .fc-theme-standard th { border-color: #f3f4f6; }
    .fc-col-header-cell-cushion { padding: 8px 0; font-size: 0.85rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
    .fc-daygrid-day-number { color: #374151; font-weight: 500; padding: 8px !important; }
    .fc-day-today { background-color: #fdf2f8 !important; }

    .fc-event { 
        border-radius: 6px; 
        border: none; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        margin-bottom: 2px !important;
        cursor: pointer;
        transition: transform 0.1s;
    }
    .fc-event:hover { transform: scale(1.02); z-index: 10; }
</style>
{% endblock %}