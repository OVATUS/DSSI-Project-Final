{# templates/boards/components/popup_task_form.html #}
<div
  x-cloak
  x-show="taskModalOpen"
  x-transition:enter="transition ease-out duration-200"
  x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
  x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
  x-transition:leave="transition ease-in duration-150"
  x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
  x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
  class="fixed inset-0 z-60 flex items-center justify-center p-4 sm:p-6"
>
  <div
    class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity"
    @click="taskModalOpen = false"
  ></div>

  <div
    class="relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all flex flex-col max-h-[90vh]"
    @click.stop
  >
    {# --- HEADER --- #}
    <div
      class="px-6 py-4 border-b border-gray-100 flex items-start justify-between bg-gray-50/50"
    >
      <div class="space-y-1">
        <h3 class="text-sm font-medium text-gray-500 flex items-center gap-2">
          <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå:</span>
          <span
            x-text="taskListTitle"
            class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wide"
          ></span>
        </h3>
        <div class="text-xs text-gray-400">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>
      </div>

      <button
        type="button"
        class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors"
        @click="taskModalOpen = false"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    {# --- BODY --- #}
    <div class="flex-1 overflow-y-auto p-6">
      <div class="grid grid-cols-1 lg:grid-cols-[3fr,1fr] gap-8">
        {# ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: FORM #}
        <div>
          <form method="post" :action="taskActionUrl" class="space-y-6">
            {% csrf_token %}

            {# --- SECTION 1: ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≤‡∏ô --- #}
            <div>
                <div class="flex items-center gap-2 mb-3 pb-2 border-b-2 border-gray-100">
                    <span class="text-indigo-500 text-lg">üìã</span>
                    <h4 class="font-bold text-gray-800 text-sm uppercase tracking-wide">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≤‡∏ô (Task Title)</h4>
                </div>
                
                <div class="space-y-2">
                    <label class=" text-sm font-semibold text-gray-700 hidden"
                        >‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≤‡∏ô <span class="text-red-500">*</span></label
                    >
                    <input
                        type="text"
                        name="title"
                        x-model="taskTitle"
                        class="w-full text-lg font-medium placeholder-gray-400 border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3 bg-gray-50/50 hover:bg-white transition-colors"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Home, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Bug Login..."
                        required
                    />
                </div>
            </div>

            {# --- SECTION 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î --- #}
            <div>
                <div class="flex items-center gap-2 mb-3 pb-2 border-b-2 border-gray-100 mt-6">
                    <span class="text-indigo-500 text-lg">üìù</span>
                    <h4 class="font-bold text-gray-800 text-sm uppercase tracking-wide">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Description)</h4>
                </div>

                <div class="space-y-2">
                    <textarea
                        name="description"
                        x-model="taskDescription"
                        rows="5"
                        class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3 bg-gray-50/50 hover:bg-white transition-colors placeholder-gray-400"
                        placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô..."
                    ></textarea>
                </div>
            </div>

            <div x-show="taskMode === 'edit'" class="mt-6">
              <div class="flex items-center gap-2 mb-3 pb-2 border-b-2 border-gray-100">
                  <span class="text-indigo-500 text-lg">‚òëÔ∏è</span>
                  <div class="flex-1 flex items-center justify-between">
                      <h4 class="font-bold text-gray-800 text-sm uppercase tracking-wide">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏™‡∏ï‡πå (Checklist)</h4>
                      <span class="text-xs text-gray-500 font-medium" x-text="`${checklistItems.filter(i => i.is_completed).length}/${checklistItems.length}`"></span>
                  </div>
              </div>

              <div class="w-full bg-gray-200 rounded-full h-1.5 mb-4" x-show="checklistItems.length > 0">
                  <div class="bg-indigo-500 h-1.5 rounded-full transition-all duration-300"
                      :style="`width: ${checklistItems.length > 0 ? (checklistItems.filter(i => i.is_completed).length / checklistItems.length) * 100 : 0}%`">
                  </div>
              </div>

              <div class="space-y-2 mb-3">
                  <template x-for="(item, index) in checklistItems" :key="item.id">
                      <div class="flex items-start gap-3 group hover:bg-gray-50 p-1.5 rounded-md transition-colors">
                          <input 
                              type="checkbox" 
                              x-model="item.is_completed"
                              @change="
                                  fetch(`/board/checklist/${item.id}/update/`, {
                                      method: 'POST',
                                      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                                      body: JSON.stringify({ is_completed: item.is_completed })
                                  })
                              "
                              class="mt-1 w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                          >
                          
                          <span 
                              x-text="item.content" 
                              class="text-sm flex-1 break-words transition-all"
                              :class="item.is_completed ? 'text-gray-400 line-through' : 'text-gray-700'"
                          ></span>

                          <button 
                              type="button"
                              class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-0.5"
                              @click="
                                  if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
                                      fetch(`/board/checklist/${item.id}/delete/`, {
                                          method: 'POST',
                                          headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                                      })
                                      .then(res => res.json())
                                      .then(data => {
                                          if(data.success) {
                                              checklistItems = checklistItems.filter(i => i.id !== item.id);
                                          }
                                      })
                                  }
                              "
                          >
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                          </button>
                      </div>
                  </template>
              </div>

              <div class="mt-2">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        x-model="newChecklistItem"
                        @keydown.enter.prevent="
                            if(!newChecklistItem.trim()) return;
                            fetch(`/board/task/${taskId}/checklist/create/`, {
                                method: 'POST',
                                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                                body: JSON.stringify({ content: newChecklistItem })
                            })
                            .then(res => res.json())
                            .then(data => {
                                if(data.success) {
                                    checklistItems.push({
                                        id: data.id,
                                        content: data.content,
                                        is_completed: data.is_completed
                                    });
                                    newChecklistItem = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á
                                }
                            })
                        "
                        class="flex-1 text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-1.5 placeholder-gray-400 bg-gray-50 focus:bg-white transition-colors"
                        placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢..."
                    >
                    <button 
                        type="button"
                        @click="
                            if(!newChecklistItem.trim()) return;
                            fetch(`/board/task/${taskId}/checklist/create/`, {
                                method: 'POST',
                                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                                body: JSON.stringify({ content: newChecklistItem })
                            })
                            .then(res => res.json())
                            .then(data => {
                                if(data.success) {
                                    checklistItems.push({
                                        id: data.id,
                                        content: data.content,
                                        is_completed: data.is_completed
                                    });
                                    newChecklistItem = '';
                                }
                            })
                        "
                        class="px-3 py-1.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-sm font-medium transition-colors"
                    >
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°
                    </button>
                </div>
            </div>
          </div>

          <div x-show="taskMode === 'edit'" class="mt-6">
    <div class="flex items-center gap-2 mb-3 pb-2 border-b-2 border-gray-100">
        <span class="text-indigo-500 text-lg">üìé</span>
        <h4 class="font-bold text-gray-800 text-sm uppercase tracking-wide">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (Attachments)</h4>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
        <template x-for="file in attachmentItems" :key="file.id">
            <div class="group relative flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-all">
                
                <div class="shrink-0 w-10 h-10 rounded bg-gray-200 flex items-center justify-center overflow-hidden">
                    <template x-if="file.is_image">
                        <img :src="file.url" class="w-full h-full object-cover" />
                    </template>
                    <template x-if="!file.is_image">
                        <span class="text-gray-500 text-xs font-bold">FILE</span>
                    </template>
                </div>

                <div class="min-w-0 flex-1">
                    <a :href="file.url" target="_blank" class="block text-sm font-medium text-gray-700 truncate hover:text-indigo-600 hover:underline" x-text="file.filename"></a>
                    <p class="text-[10px] text-gray-400" x-text="'‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ ' + file.uploaded_at"></p>
                </div>

                <button 
                    type="button"
                    class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                    @click="
                        if(confirm('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ?')) {
                            fetch(`/board/attachment/${file.id}/delete/`, {
                                method: 'POST',
                                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                            })
                            .then(res => res.json())
                            .then(data => {
                                if(data.success) {
                                    attachmentItems = attachmentItems.filter(f => f.id !== file.id);
                                }
                            })
                        }
                    "
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        </template>
    </div>

    <div>
        <label class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-md transition-colors border border-gray-300 border-dashed">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...</span>
            <input 
                type="file" 
                class="hidden" 
                @change="
                    if($event.target.files.length > 0) {
                        const formData = new FormData();
                        formData.append('file', $event.target.files[0]);
                        
                        fetch(`/board/task/${taskId}/attachment/create/`, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': '{{ csrf_token }}' }, // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Content-Type ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á FormData
                            body: formData
                        })
                        .then(res => res.json())
                        .then(data => {
                            if(data.success) {
                                attachmentItems.unshift({
                                    id: data.id,
                                    filename: data.filename,
                                    url: data.url,
                                    is_image: data.is_image,
                                    uploaded_at: data.uploaded_at
                                });
                            } else {
                                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.error || 'Unknown error'));
                            }
                            $event.target.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå input
                        })
                    }
                "
            >
        </label>
    </div>
</div>


            {# --- SECTION 3: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Grid) --- #}
          <div>
              <div class="flex items-center gap-2 mb-3 pb-2 border-b-2 border-gray-100 mt-6">
                  <span class="text-indigo-500 text-lg">‚öôÔ∏è</span>
                  <h4 class="font-bold text-gray-800 text-sm uppercase tracking-wide">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</h4>
              </div>

              <div
                class="bg-gray-50 rounded-xl p-4 border border-gray-100 grid grid-cols-1 sm:grid-cols-3 gap-4"
              >
              <div>
                <label
                  class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider"
                  >‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                </label>
                    <div class="relative">
                    <select
                        name="assigned_to"
                        x-model="taskAssignedTo"
                        class="block w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white pl-3 pr-8 py-2"
                    >
                        <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.username }}</option>
                        {% endfor %}
                    </select>
                    </div>
                </div>

                <div>
                    <label
                    class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider"
                    >‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label
                    >
                    <select
                    name="priority"
                    x-model="taskPriority"
                    class="block w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white py-2"
                    >
                    {% for value, label in priority_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                    </select>
                </div>

                <div>
                    <label
                    class="block text-xs font-semibold text-gray-500 mb-1.5 uppercase tracking-wider"
                    >‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label
                    >
                    <input
                    type="datetime-local"
                    name="due_date"
                    x-model="taskDueDate"
                    class="block w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white py-2 text-gray-600"
                    />
                </div>

                <div class="pt-6 border-t border-gray-200">
                  <button 
                      type="button" 
                      @click="toggleArchive({{ task.id }}, '{{ csrf_token }}')"
                      class="w-full text-sm font-medium px-3 py-2 rounded-lg transition-colors flex items-center justify-center gap-2"
                      :class="taskIsArchived ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                  >
                      <svg x-show="!taskIsArchived" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      <svg x-show="taskIsArchived" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                      
                      <span x-text="taskIsArchived ? '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£' : '‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ (Archive)'"></span>
                  </button>
              </div>

               {# --- SECTION 4: ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Grid) --- #}
              <div 
                class="col-span-1 sm:col-span-3 space-y-2 mt-4 pt-4 border-t border-gray-200"
                x-data="{ showCreateLabel: false, newLabelName: '', newLabelColor: 'bg-blue-500' }"
              >
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-indigo-500 text-base">üè∑Ô∏è</span>
                        <label class="block text-sm font-bold text-gray-800 uppercase tracking-wide">‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö (Labels)</label>
                    </div>
                    <button 
                        type="button" 
                        @click="showCreateLabel = !showCreateLabel" 
                        class="text-xs text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100 transition-colors"
                    >
                        <span x-text="showCreateLabel ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà'"></span>
                    </button>
                </div>

                <div>
                    <div x-show="showCreateLabel" x-transition class="bg-white p-3 rounded-lg border border-gray-200 mb-3 space-y-3 shadow-sm">
                        <div>
                            <input type="text" x-model="newLabelName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡πà‡∏ß‡∏ô, Bug)" 
                                class="w-full text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 px-3 py-1.5 placeholder-gray-400">
                        </div>
                        
                        <div>
                            <div class="text-xs text-gray-500 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ:</div>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" @click="newLabelColor = 'bg-red-500'" :class="{'ring-2 ring-offset-2 ring-gray-400 scale-110': newLabelColor === 'bg-red-500'}" class="w-6 h-6 rounded-full bg-red-500 border border-white shadow-sm hover:scale-110 transition-all"></button>
                                <button type="button" @click="newLabelColor = 'bg-orange-500'" :class="{'ring-2 ring-offset-2 ring-gray-400 scale-110': newLabelColor === 'bg-orange-500'}" class="w-6 h-6 rounded-full bg-orange-500 border border-white shadow-sm hover:scale-110 transition-all"></button>
                                <button type="button" @click="newLabelColor = 'bg-yellow-400'" :class="{'ring-2 ring-offset-2 ring-gray-400 scale-110': newLabelColor === 'bg-yellow-400'}" class="w-6 h-6 rounded-full bg-yellow-400 border border-white shadow-sm hover:scale-110 transition-all"></button>
                                <button type="button" @click="newLabelColor = 'bg-green-500'" :class="{'ring-2 ring-offset-2 ring-gray-400 scale-110': newLabelColor === 'bg-green-500'}" class="w-6 h-6 rounded-full bg-green-500 border border-white shadow-sm hover:scale-110 transition-all"></button>
                                <button type="button" @click="newLabelColor = 'bg-blue-500'" :class="{'ring-2 ring-offset-2 ring-gray-400 scale-110': newLabelColor === 'bg-blue-500'}" class="w-6 h-6 rounded-full bg-blue-500 border border-white shadow-sm hover:scale-110 transition-all"></button>
                                <button type="button" @click="newLabelColor = 'bg-indigo-500'" :class="{'ring-2 ring-offset-2 ring-gray-400 scale-110': newLabelColor === 'bg-indigo-500'}" class="w-6 h-6 rounded-full bg-indigo-500 border border-white shadow-sm hover:scale-110 transition-all"></button>
                                <button type="button" @click="newLabelColor = 'bg-pink-500'" :class="{'ring-2 ring-offset-2 ring-gray-400 scale-110': newLabelColor === 'bg-pink-500'}" class="w-6 h-6 rounded-full bg-pink-500 border border-white shadow-sm hover:scale-110 transition-all"></button>
                                <button type="button" @click="newLabelColor = 'bg-gray-500'" :class="{'ring-2 ring-offset-2 ring-gray-400 scale-110': newLabelColor === 'bg-gray-500'}" class="w-6 h-6 rounded-full bg-gray-500 border border-white shadow-sm hover:scale-110 transition-all"></button>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded border border-gray-100">
                            <span class="text-xs text-gray-400">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</span>
                            <div 
                                class="px-3 py-1 rounded-full text-xs font-medium text-white shadow-sm transition-all"
                                :class="newLabelColor"
                            >
                                <span x-text="newLabelName || '‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö'"></span>
                            </div>
                        </div>

                        <button type="button" 
                            @click="
                                if(!newLabelName) return;
                                fetch('{% url 'create_label' board.id %}', {
                                    method: 'POST',
                                    headers: { 
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token }}'
                                    },
                                    body: JSON.stringify({ name: newLabelName, color: newLabelColor })
                                })
                                .then(res => res.json())
                                .then(data => {
                                    if(data.success) {
                                        const container = document.getElementById('label-container');
                                        const html = `
                                        <label class='cursor-pointer relative group'>
                                            <input type='checkbox' name='labels' value='${data.id}' class='peer sr-only' checked>
                                            <div class='px-3 py-1 rounded-full text-xs font-medium text-white opacity-40 hover:opacity-100 peer-checked:opacity-100 peer-checked:ring-2 peer-checked:ring-offset-1 peer-checked:ring-gray-400 transition-all ${data.color} shadow-sm'>
                                                ${data.name}
                                            </div>
                                            <svg class='h-3 w-3 absolute -top-1 -right-1 text-green-600 bg-white rounded-full block shadow-sm' viewBox='0 0 20 20' fill='currentColor'><path fill-rule='evenodd' d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z' clip-rule='evenodd' /></svg>
                                        </label>`;
                                        container.insertAdjacentHTML('beforeend', html);
                                        
                                        const noLabelText = document.getElementById('no-label-text');
                                        if(noLabelText) noLabelText.style.display = 'none';

                                        newLabelName = '';
                                        showCreateLabel = false;
                                        if(typeof taskLabels !== 'undefined') taskLabels.push(data.id);
                                    }
                                })
                            "
                            class="w-full bg-indigo-600 text-white text-xs font-bold py-1.5 rounded-md hover:bg-indigo-700 transition shadow-sm"
                        >
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>

                    <div id="label-container" class="flex flex-wrap gap-2 min-h-[30px]">
                        {% for label in labels %}
                        <label class="cursor-pointer relative group">
                            <input 
                                type="checkbox" 
                                name="labels" 
                                value="{{ label.id }}" 
                                class="peer sr-only"
                                x-model="taskLabels"
                            >
                            <div class="px-3 py-1 rounded-full text-xs font-medium text-white opacity-40 hover:opacity-100 peer-checked:opacity-100 peer-checked:ring-2 peer-checked:ring-offset-1 peer-checked:ring-gray-400 transition-all {{ label.color }} shadow-sm">
                                {{ label.name }}
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 absolute -top-1 -right-1 text-green-600 bg-white rounded-full hidden peer-checked:block shadow-sm z-10" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </label>
                        {% empty %}
                            <p id="no-label-text" class="text-xs text-gray-400 bg-white/50 p-2 rounded border border-dashed border-gray-300 w-full text-center">
                                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö
                            </p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="pt-4 flex items-center gap-3 border-t border-gray-100 mt-6">
              <button
                type="submit"
                class="flex-1 sm:flex-none px-6 py-2.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î
              </button>

              <button
                type="button"
                class="flex-1 sm:flex-none px-6 py-2.5 rounded-lg bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-sm font-medium transition-colors"
                @click="taskModalOpen = false"
              >
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
            </div>
          </form>
        </div>

        {# ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: COMMENTS #}
      <div class="hidden lg:flex flex-col h-10 space-y-4">
        <div
            class="bg-gray-50 rounded-xl border border-gray-200 p-4 flex-1 flex flex-col max-h-[500px]"
        >
          <h4
              class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"
          >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
                  clip-rule="evenodd"
                />
              </svg>
              ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
            </h4>

            <div
              class="flex-1 overflow-y-auto space-y-3 pr-2 mb-3 custom-scrollbar"
            >
              <div
                x-show="isLoadingComments"
                class="text-center py-4 text-gray-400 text-xs"
              >
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
              </div>

              <div
                x-show="!isLoadingComments && comments.length === 0"
                class="text-center py-4 text-gray-400 text-xs"
              >
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
              </div>

              <template x-for="comment in comments" :key="comment.id">
                <div class="flex gap-3 text-sm">
                  <div
                    class="shrink-0 w-8 h-8 rounded-full bg-gray-300 overflow-hidden"
                  >
                    <template x-if="comment.author_avatar">
                      <img
                        :src="comment.author_avatar"
                        class="w-full h-full object-cover"
                      />
                    </template>
                    <template x-if="!comment.author_avatar">
                      <div
                        class="w-full h-full flex items-center justify-center bg-indigo-500 text-white text-[10px] font-bold"
                      >
                        <span
                          x-text="comment.author.charAt(0).toUpperCase()"
                        ></span>
                      </div>
                    </template>
                  </div>

                  <div class="flex-1">
                    <div class="flex items-baseline justify-between">
                      <span
                        class="font-bold text-gray-800 text-xs"
                        x-text="comment.author"
                      ></span>
                      <span
                        class="text-[10px] text-gray-400"
                        x-text="comment.created_at"
                      ></span>
                    </div>
                    <div
                      class="bg-white p-2 rounded-lg border border-gray-200 mt-1 shadow-sm text-gray-600"
                      x-text="comment.content"
                    ></div>
                  </div>
                </div>
              </template>
            </div>

            <div class="mt-auto" x-show="taskMode === 'edit'">
              <div class="relative">
                <input
                  type="text"
                  x-model="newCommentText"
                  @keydown.enter.prevent="postComment()"
                  placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."
                  class="w-full text-sm border-gray-300 rounded-full shadow-sm focus:border-indigo-500 focus:ring-indigo-500 pr-10 py-2"
                />
                <button
                  @click="postComment()"
                  class="absolute right-2 top-1.5 text-indigo-600 hover:text-indigo-800 p-1"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"
                    />
                  </svg>
                </button>
              </div>
              <div class="text-[10px] text-gray-400 mt-1 text-right">
                ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á
              </div>
            </div>

            <div
              x-show="taskMode === 'create'"
              class="mt-auto text-center text-xs text-gray-400 py-2 bg-gray-100 rounded"
            >
              ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏î‡πâ
            </div>
          </div>

          <div class="text-[10px] text-gray-400 text-center px-4">
            <p>
              Tips: ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ Esc ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>